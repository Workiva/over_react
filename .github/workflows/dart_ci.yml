name: CI

on:
  push:
    branches:
      - 'master'
      - 'test_consume_**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: read
  checks: write
  deployments: write
  id-token: write
  pull-requests: write
  statuses: read

jobs:
  source-check:
    uses: ./.github/workflows/source-check.yml
  lib:
    needs: [ source-check ]
    strategy:
      fail-fast: false
      matrix:
        # Can't run on `dev` (Dart 3) until we're fully null-safe.
        sdk: [ 2.18.7, 2.19.6 ]
    uses: ./.github/workflows/lib_ci.yml
    with:
      sdk: ${{ matrix.sdk }}
      # Only generate coverage for the latest SDK we support
      gen_coverage: ${{ matrix.sdk == '2.19.6' }}
      run_dart_checks: ${{ needs.source-check.outputs.run_dart_checks == 'true' }}
      is_tag_build: ${{ needs.source-check.outputs.is_tag_build == 'true' }}

  analyzer-plugin:
    needs: [ source-check ]
    if: ${{ needs.source-check.outputs.is_tag_build == 'false' && needs.source-check.outputs.run_dart_checks == 'true' }}
    strategy:
      fail-fast: false
      matrix:
        # Can't run on `dev` (Dart 3) until we're fully null-safe.
        sdk: [ 2.19.6 ]
    uses: ./.github/workflows/plugin_ci.yml
    with:
      sdk: ${{ matrix.sdk }}